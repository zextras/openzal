targets=(
  "centos"
  "ubuntu"
)
pkgname="carbonio-zal"
pkgver="3.13.0"
pkgrel="1"
pkgdesc="Carbonio extras"
pkgdesclong=(
  "Abstraction Layer for Carbonio"
)
maintainer="Zextras <packages@zextras.com>"
arch="all"
license=("GPLv2")
section="admin"
priority="optional"
url="https://www.zextras.com/"

build() {
}

package() {
  cd ..
  find . -name "zal-${pkgver}-*.jar" | while read i; do install -Dm 744 $i "${pkgdir}/opt/zextras/zal/$i"; done
}

postinst() {
  ZIMBRA_VERSION=$(/opt/zextras/bin/zmjava com.zimbra.cs.util.BuildInfo | grep '^Version:' | sed -E "s#^Version: ([.0-9]+).*#\1#")
  ZAL_JAR="/opt/zextras/zal/zal-${pkgver}-zimbra-$ZIMBRA_VERSION.jar"

  if test -f "$ZAL_JAR"; then
    rm -f /opt/zextras/lib/ext/carbonio/zal.jar
    mkdir -p /opt/zextras/lib/ext/carbonio
    ln -s $ZAL_JAR "/opt/zextras/lib/ext/carbonio/zal.jar"
    echo "======================================================"
    echo "Carbonio ZAL installed successfully!"
    echo "======================================================"
  else
    echo "======================================================"
    echo "Error: unrecognized Carbonio version $ZIMBRA_VERSION"
    echo "======================================================"
    exit 1
  fi
}

prerm() {
}

postrm() {
  rm -f /opt/zextras/lib/ext/carbonio/zal.jar
}
